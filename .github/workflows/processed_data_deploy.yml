# model_deploy.yml - 배포 전용 워크플로우
on:
  workflow_dispatch:

jobs:
  preprocess_and_deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v2

      # 2. Python 설치
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.11

      # 3. 필요한 패키지 설치
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r LongTermTravelPlanner/requirements.txt
          pip install boto3

      # 4. 전처리 과정 실행 (preprocess.py)
      - name: Preprocess data
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_PUBLIC_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_PRIVATE_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          python LongTermTravelPlanner/src/preprocess.py

      # 5. S3로 전처리된 파일 업로드
      - name: Upload processed data to S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_PUBLIC_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_PRIVATE_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        run: |
          aws s3 cp LongTermTravelPlanner/data/processed/processed_train_data.csv s3://$S3_BUCKET_NAME/LongTermDataFrame/data/processed/processed_train_data.csv
          aws s3 cp LongTermTravelPlanner/data/processed/processed_test_data.csv s3://$S3_BUCKET_NAME/LongTermDataFrame/data/processed/processed_test_data.csv
        continue-on-error: true  # 에러가 발생하더라도 계속 진행

